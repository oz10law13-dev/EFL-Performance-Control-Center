{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://elitefitness.lab/schemas/uid_role_registry_v1.0.1.json",
  "title": "EFL UID & Role Registry Schema v1.0.1 (PATCHED)",
  "description": "Defines user identities, roles, and access tiers for EFL training governance system. v1.0.1: Locked capabilities to known intents, added Coach scope enforcement.",
  "type": "object",
  "required": ["schema_version", "registry_metadata", "roles", "users"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.1"
    },
    "registry_metadata": {
      "type": "object",
      "required": ["lastupdated", "admin_contact"],
      "properties": {
        "lastupdated": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last registry update"
        },
        "admin_contact": {
          "type": "string",
          "format": "email"
        }
      }
    },
    "roles": {
      "type": "object",
      "description": "Role definitions with capabilities and constraints",
      "required": ["Coach", "SeniorCoach", "MedicalProvider", "Admin", "QA", "System"],
      "properties": {
        "Coach": {
          "$ref": "#/$defs/RoleDefinition"
        },
        "SeniorCoach": {
          "$ref": "#/$defs/RoleDefinition"
        },
        "MedicalProvider": {
          "$ref": "#/$defs/RoleDefinition"
        },
        "Admin": {
          "$ref": "#/$defs/RoleDefinition"
        },
        "QA": {
          "$ref": "#/$defs/RoleDefinition"
        },
        "System": {
          "$ref": "#/$defs/RoleDefinition"
        }
      }
    },
    "users": {
      "type": "array",
      "description": "List of registered users with assigned roles",
      "items": {
        "$ref": "#/$defs/UserRecord"
      }
    }
  },
  "$defs": {
    "IntentID": {
      "type": "string",
      "enum": [
        "REQUEST_SESSION_GENERATION",
        "REQUEST_MESOCYCLE_GENERATION",
        "SUBMIT_MANUAL_PROGRAM",
        "REQUEST_OVERRIDE_STAGE",
        "APPROVE_OVERRIDE",
        "REQUEST_OVERRIDE_CAP",
        "DEPLOY_GENERATOR_VERSION",
        "UPDATE_PROJECT_SPEC",
        "UPDATE_ARTIFACT_SCHEMA",
        "QUERY_ARTIFACT_HISTORY",
        "QUERY_VIOLATIONS",
        "GENERATE_COMPLIANCE_REPORT"
      ],
      "description": "Valid training intent identifiers from EFL_TRAINING_INTENT_MANIFEST_v1.0.1"
    },
    "RoleDefinition": {
      "type": "object",
      "required": ["role_id", "role_name", "tier", "description", "capabilities"],
      "properties": {
        "role_id": {
          "type": "string",
          "description": "Unique role identifier"
        },
        "role_name": {
          "type": "string"
        },
        "tier": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "description": "Access tier: 0=System, 1=Coach, 2=SeniorCoach, 3=MedicalProvider, 4=QA, 5=Admin. NOTE: Higher tier does NOT imply capability inheritance."
        },
        "description": {
          "type": "string"
        },
        "capabilities": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/IntentID"
          },
          "description": "List of permitted intents (locked to valid intent IDs from manifest)"
        },
        "constraints": {
          "type": "object",
          "properties": {
            "athlete_scope": {
              "type": "string",
              "enum": ["OWN_ONLY", "FACILITY_ALL", "SYSTEM_ALL"],
              "description": "Scope of athlete access"
            },
            "requires_mfa": {
              "type": "boolean",
              "default": false
            },
            "max_concurrent_sessions": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      }
    },
    "UserRecord": {
      "type": "object",
      "required": ["uid", "username", "email", "role", "status", "registered_at"],
      "properties": {
        "uid": {
          "type": "string",
          "format": "uuid",
          "description": "Unique user identifier"
        },
        "username": {
          "type": "string",
          "minLength": 3,
          "maxLength": 50
        },
        "email": {
          "type": "string",
          "format": "email"
        },
        "role": {
          "type": "string",
          "enum": ["Coach", "SeniorCoach", "MedicalProvider", "Admin", "QA", "System"]
        },
        "status": {
          "type": "string",
          "enum": ["ACTIVE", "SUSPENDED", "INACTIVE"],
          "default": "ACTIVE"
        },
        "registered_at": {
          "type": "string",
          "format": "date-time"
        },
        "last_login": {
          "type": "string",
          "format": "date-time"
        },
        "assigned_athletes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of clientids this user has access to. REQUIRED for Coach role, MUST be empty for other roles."
        },
        "mfa_enabled": {
          "type": "boolean",
          "default": false
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "role": {
                "const": "Coach"
              }
            }
          },
          "then": {
            "required": ["assigned_athletes"],
            "properties": {
              "assigned_athletes": {
                "minItems": 1,
                "description": "Coach MUST have at least one assigned athlete"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "role": {
                "enum": ["SeniorCoach", "MedicalProvider", "Admin", "QA", "System"]
              }
            }
          },
          "then": {
            "properties": {
              "assigned_athletes": {
                "maxItems": 0,
                "description": "Non-Coach roles MUST NOT have assigned_athletes (use facility/system scope instead)"
              }
            }
          }
        }
      ]
    }
  }
}
